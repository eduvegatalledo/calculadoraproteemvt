<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fitness Macros ‚Äî Calculadora Nutricional</title>
  <meta name="description" content="Calcula tus macros, prote√≠na diaria y analiza platos y alimentos. Dise√±ado para p√∫blico fitness con objetivos de p√©rdida de grasa, mantenimiento o ganancia muscular." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèãÔ∏è</text></svg>">

  <!-- Open Graph / SEO -->
  <meta property="og:title" content="Fitness Macros ‚Äî Calculadora Nutricional">
  <meta property="og:description" content="Calcula tus macros, prote√≠na diaria y analiza platos y alimentos, con objetivos de corte, mantenimiento o volumen.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="es_PE">
  <meta property="og:url" content="https://calculadoraproteemvt.vercel.app/">
  <meta property="og:image" content="https://calculadoraproteemvt.vercel.app/og-image.png">

  <!-- (Opcional) Google Analytics 4 (descomenta y a√±ade tu ID)
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-XXXXXXXXXX');
  </script>
  -->

  <!-- (Opcional) Google AdSense (descomenta cuando te aprueben)
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
  -->

  <style>
    :root{
      --bg:#0f1115;--card:#171a21;--muted:#9aa4b2;--text:#e6e9ef;
      --accent:#4cc9f0;--accent-2:#a1ffce;--warn:#ffd166;--good:#8aff80;--bad:#ff6b6b;
      --border:#2a2f3a;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0f1115, #0e1218 20%, #10141b 100%);
      color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45;
    }
    header{position:sticky;top:0;background:rgba(15,17,21,.85);backdrop-filter:blur(8px);z-index:5;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 18px}
    h1{font-size:1.6rem;margin:0}
    h2{font-size:1.2rem;margin:22px 0 10px}
    h3{font-size:1rem;margin:18px 0 6px}
    p,small{color:var(--muted)}
    .grid{display:grid;gap:14px}
    .g-2{grid-template-columns:1fr 1fr}
    .g-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){.g-2,.g-3{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    label{display:block;font-size:.9rem;margin:8px 0 6px}
    input,select,button,textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:#0f131a;color:var(--text);outline:none
    }
    input[type="number"]{appearance:textfield}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#6ef3c5);color:#001015;border:0;font-weight:600}
    button.ghost{background:transparent;border:1px dashed var(--border)}
    .kpi{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px}
    .kpi .pill{background:#0e1218;border:1px solid var(--border);padding:10px 12px;border-radius:100px}
    .muted{color:var(--muted)}
    .ad-slot{border:1px dashed var(--border);border-radius:12px;min-height:90px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.9rem}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:#c6d0e7}
    .tag{display:inline-block;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:.75rem;color:var(--muted);margin-right:6px}
    .footer{margin:28px 0 60px;font-size:.85rem}
    a{color:var(--accent)}
    .small{font-size:.85rem}
    .chip{display:inline-flex;gap:8px;align-items:center;background:#0e1218;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1>Fitness Macros ‚Äî Calculadora Nutricional</h1>
        <div class="actions" style="justify-content:end">
          <button id="saveProfile" class="ghost">üíæ Guardar</button>
          <button id="resetAll" class="ghost">‚ôªÔ∏è Reiniciar</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <div class="ad-slot card" id="ad-top">
      <span>Espacio para anuncio (970√ó90/728√ó90).</span>
      <!-- Ejemplo AdSense (descomenta y reemplaza data-ad-slot)
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXXXXXXXXXXXXX" data-ad-slot="1111111111" data-ad-format="horizontal"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      -->
    </div>

    <section class="card">
      <h2>1) Tu Perfil</h2>
      <p>Completa tus datos para personalizar tus c√°lculos. Puedes alternar unidades (m√©trico/imperial).</p>
      <div class="row">
        <div>
          <label for="units">Unidades</label>
          <select id="units">
            <option value="metric">M√©trico (kg, cm)</option>
            <option value="imperial">Imperial (lb, in)</option>
          </select>
        </div>
        <div>
          <label for="sex">Sexo</label>
          <select id="sex">
            <option value="male">Masculino</option>
            <option value="female">Femenino</option>
          </select>
        </div>
      </div>
      <div class="row3">
        <div><label for="age">Edad (a√±os)</label><input id="age" type="number" min="10" max="90" placeholder="30"></div>
        <div><label for="height">Altura (<span class="unit-h">cm</span>)</label><input id="height" type="number" min="80" max="230" placeholder="175"></div>
        <div><label for="weight">Peso (<span class="unit-w">kg</span>)</label><input id="weight" type="number" min="30" max="250" placeholder="75"></div>
      </div>
      <div class="row">
        <div>
          <label for="activity">Actividad</label>
          <select id="activity">
            <option value="1.2">Sedentario</option>
            <option value="1.375">Ligero (1-3 d√≠as/sem)</option>
            <option value="1.55" selected>Moderado (3-5 d√≠as/sem)</option>
            <option value="1.725">Intenso (6-7 d√≠as/sem)</option>
            <option value="1.9">Muy intenso (2x d√≠a)</option>
          </select>
        </div>
        <div>
          <label for="goal">Objetivo</label>
          <select id="goal">
            <option value="cut">Definici√≥n (p√©rdida de grasa)</option>
            <option value="recomp" selected>Mantenimiento / Recomp</option>
            <option value="bulk">Volumen magro</option>
          </select>
        </div>
      </div>
      <details style="margin-top:8px">
        <summary>Opciones avanzadas (IMC, % grasa, masa magra, grasas m√≠n., etc.)</summary>
        <div class="row3" style="margin-top:10px">
          <div><label for="bfp">Grasa corporal (%)</label><input id="bfp" type="number" min="0" max="70" step="0.1" placeholder="15"></div>
          <div><label for="bmi">IMC (se calcula)</label><input id="bmi" type="number" step="0.1" placeholder="‚Äî" disabled></div>
          <div><label for="minFat">Grasas m√≠n. g/kg</label><input id="minFat" type="number" min="0.3" max="1.5" step="0.05" value="0.6"></div>
        </div>
        <div class="row">
          <div><label for="proteinMethod">Prote√≠na objetivo</label>
            <select id="proteinMethod">
              <option value="bw1.8">1.8 g/kg peso (est√°ndar)</option>
              <option value="bw2.0">2.0 g/kg peso</option>
              <option value="lbm2.2">2.2 g/kg masa magra (si hay % grasa)</option>
            </select>
          </div>
          <div><label for="meals">Comidas al d√≠a</label><input id="meals" type="number" min="1" max="8" value="3"></div>
        </div>
      </details>
      <div class="actions" style="margin-top:12px">
        <button id="calcTDEE" class="primary">Calcular TDEE y Macros</button>
      </div>

      <div id="results" style="margin-top:12px;display:none">
        <div class="kpi">
          <div class="pill"><strong>BMR</strong>: <span id="kpiBMR">‚Äî</span> kcal</div>
          <div class="pill"><strong>TDEE</strong>: <span id="kpiTDEE">‚Äî</span> kcal</div>
          <div class="pill"><strong>Calor√≠as objetivo</strong>: <span id="kpiTarget">‚Äî</span> kcal</div>
        </div>
        <h3>Macros diarios objetivo</h3>
        <table>
          <thead><tr><th>Macronutriente</th><th>Gramos/d√≠a</th><th>Calor√≠as</th><th>Por comida (<span id="perMeals">x</span>)</th></tr></thead>
          <tbody id="macroTable"></tbody>
        </table>
        <small class="muted">Nota: la prote√≠na puede redondearse ¬±10% sin afectar resultados; las grasas no deben bajar de tu m√≠nimo saludable.</small>
      </div>
    </section>

    <section class="card">
      <h2>2) Analizador de Platos / Constructor de Comidas</h2>
      <div class="row">
        <div>
          <label for="foodSearch">Buscar alimento</label>
          <input id="foodSearch" placeholder="Ej. pechuga de pollo, arroz, avena..." />
        </div>
        <div>
          <label for="qty">Cantidad (g)</label>
          <input id="qty" type="number" min="1" value="100" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px">
        <button id="addFood" class="primary">A√±adir a la comida</button>
        <button id="newFood" class="ghost">Agregar alimento personalizado</button>
      </div>

      <div id="foodSuggestions" class="small" style="margin-top:6px"></div>

      <h3>Mi comida</h3>
      <table>
        <thead><tr><th>Alimento</th><th>Cant. (g)</th><th>Cal</th><th>Prot</th><th>Carb</th><th>Grasa</th><th></th></tr></thead>
        <tbody id="mealBody"></tbody>
        <tfoot>
          <tr><th>Total</th><th id="tQty">‚Äî</th><th id="tKcal">‚Äî</th><th id="tP">‚Äî</th><th id="tC">‚Äî</th><th id="tF">‚Äî</th><th></th></tr>
        </tfoot>
      </table>

      <div class="actions" style="margin-top:8px">
        <button id="saveMeal" class="ghost">Guardar comida</button>
        <button id="clearMeal" class="ghost">Limpiar</button>
      </div>

      <div id="savedMealsWrap" style="margin-top:10px;display:none">
        <h3>Comidas guardadas</h3>
        <div id="savedMeals"></div>
      </div>
    </section>

    <div class="ad-slot card" id="ad-middle">
      <span>Espacio para anuncio (300√ó250 / 336√ó280 / 320√ó100).</span>
      <!-- Ejemplo AdSense (descomenta y reemplaza data-ad-slot)
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXXXXXXXXXXXXX" data-ad-slot="2222222222"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      -->
    </div>

    <section class="card">
      <h2>3) Recomendaciones & Tips</h2>
      <div id="tips" class="grid"></div>
    </section>

    <section class="card">
      <h2>Agregar alimento personalizado</h2>
      <p class="small">Valores por 100 g. Se a√±adir√° a tu base local y aparecer√° en las b√∫squedas.</p>
      <div class="row3">
        <div><label>Nombre</label><input id="cfName" placeholder="Ej. Pan integral"></div>
        <div><label>Calor√≠as</label><input id="cfKcal" type="number" min="0" value="250"></div>
        <div><label>Prote√≠na (g)</label><input id="cfP" type="number" min="0" step="0.1" value="9"></div>
      </div>
      <div class="row3">
        <div><label>Carbohidratos (g)</label><input id="cfC" type="number" min="0" step="0.1" value="45"></div>
        <div><label>Grasas (g)</label><input id="cfF" type="number" min="0" step="0.1" value="3"></div>
        <div><label>&nbsp;</label><button id="addCustom" class="ghost">A√±adir alimento</button></div>
      </div>
      <div id="customMsg" class="small"></div>
    </section>

    <div class="ad-slot card" id="ad-bottom">
      <span>Espacio para anuncio (responsive).</span>
      <!-- Ejemplo AdSense responsive (descomenta y reemplaza data-ad-slot)
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXXXXXXXXXXXXX" data-ad-slot="3333333333" data-ad-format="auto" data-full-width-responsive="true"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      -->
    </div>

    <section class="footer">
      <div class="grid g-2">
        <div>
          <strong>Aviso</strong>
          <p>Esta herramienta no sustituye a un profesional de la salud. √ösala con criterio y ajusta seg√∫n tus sensaciones y resultados.</p>
        </div>
        <div>
          <span class="tag">SEO listo</span>
          <span class="tag">Core Web Vitals friendly</span>
          <span class="tag">Ads-ready</span>
          <p class="small muted">Lee nuestras <a href="/privacidad.html">Pol√≠ticas de Privacidad</a> y <a href="/terminos.html">T√©rminos</a>. <a href="/contacto.html">Contacto</a>.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Banner de cookies -->
  <div id="cookieBanner" style="position:fixed;left:0;right:0;bottom:0;background:#0e1218;border-top:1px solid var(--border);padding:12px;display:none;z-index:50">
    <div class="wrap" style="display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1100px">
      <div class="small">Usamos cookies para mejorar tu experiencia y analizar el uso del sitio. <a href="/privacidad.html">M√°s info</a>.</div>
      <div style="display:flex;gap:8px">
        <button id="cookieAccept" class="ghost">Aceptar</button>
        <button id="cookieDecline" class="ghost">Rechazar</button>
      </div>
    </div>
  </div>

  <script>
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const BASE_DB = [
    {name:"Pechuga de pollo (cocida, sin piel)", kcal:165, p:31, c:0, f:3.6},
    {name:"Clara de huevo", kcal:52, p:11, c:0.7, f:0.2},
    {name:"Huevo entero", kcal:143, p:13, c:0.7, f:9.5},
    {name:"Arroz blanco cocido", kcal:130, p:2.7, c:28, f:0.3},
    {name:"Arroz integral cocido", kcal:123, p:2.6, c:25.6, f:1},
    {name:"Quinua cocida", kcal:120, p:4.4, c:21.3, f:1.9},
    {name:"Papa hervida", kcal:87, p:1.9, c:20, f:0.1},
    {name:"Avena (seca)", kcal:389, p:16.9, c:66.3, f:6.9},
    {name:"Banana", kcal:89, p:1.1, c:23, f:0.3},
    {name:"Br√≥coli", kcal:34, p:2.8, c:7, f:0.4},
    {name:"Yogur griego natural", kcal:97, p:10, c:3.6, f:5},
    {name:"Leche descremada", kcal:34, p:3.4, c:5, f:0.1},
    {name:"Lentejas cocidas", kcal:116, p:9, c:20, f:0.4},
    {name:"Garbanzos cocidos", kcal:164, p:8.9, c:27.4, f:2.6},
    {name:"At√∫n en agua (drenado)", kcal:132, p:29, c:0, f:1},
    {name:"Salm√≥n", kcal:208, p:20, c:0, f:13},
    {name:"Carne magra (lomo res)", kcal:191, p:29, c:0, f:7.6},
    {name:"Mantequilla de man√≠", kcal:588, p:25, c:20, f:50},
    {name:"Palta (aguacate)", kcal:160, p:2, c:9, f:15},
    {name:"Aceite de oliva", kcal:884, p:0, c:0, f:100},
    {name:"Whey protein (por 100g)", kcal:400, p:80, c:8, f:6}
  ];

  function loadDB(){ const custom = JSON.parse(localStorage.getItem("customFoods")||"[]"); return [...BASE_DB, ...custom]; }
  function saveCustomFood(item){ const list = JSON.parse(localStorage.getItem("customFoods")||"[]"); list.push(item); localStorage.setItem("customFoods", JSON.stringify(list)); }
  function round(n, d=0){ return Math.round((+n + Number.EPSILON)*10**d)/10**d }

  function toMetric(weight, height){
    if ($('#units').value==='imperial'){ return { kg: +weight*0.453592, cm: +height*2.54 }; }
    return { kg:+weight, cm:+height };
  }
  function mifflinStJeor(sex, kg, cm, age){
    return sex==='male' ? (10*kg + 6.25*cm - 5*age + 5) : (10*kg + 6.25*cm - 5*age - 161);
  }
  function goalCalFactor(goal){ if (goal==='cut') return 0.8; if (goal==='bulk') return 1.12; return 1.0; }
  function proteinTarget(method, kg, bfp){ if (method==='lbm2.2' && bfp){ const lbm = kg * (1 - bfp/100); return lbm * 2.2; } if (method==='bw2.0') return kg * 2.0; return kg * 1.8; }
  function fatMinGrams(kg, minPerKg){ return Math.max(kg*minPerKg, 0); }

  function computeMacros({sex, age, height, weight, units, activity, goal, bfp, proteinMethod, minFat, meals}){
    const {kg, cm} = toMetric(weight, height);
    const bmr = mifflinStJeor(sex, kg, cm, +age);
    const tdee = bmr * +activity;
    const targetCal = tdee * goalCalFactor(goal);

    const protG = proteinTarget(proteinMethod, kg, bfp || 0);
    const fatGmin = fatMinGrams(kg, +minFat);
    const calFromProt = protG * 4;
    const calFromFatMin = fatGmin * 9;
    let remainingCal = targetCal - (calFromProt + calFromFatMin);
    let fatG = fatGmin;
    let carbG = Math.max(remainingCal/4, 0);
    if (remainingCal < 0){
      let minProt = kg*1.6; let protAdj = protG;
      while (remainingCal < 0 && protAdj > minProt){ protAdj -= 0.1; remainingCal = targetCal - (protAdj*4 + fatG*9); }
      if (remainingCal < 0){
        let minFatHard = kg*0.5;
        while (remainingCal < 0 && fatG > minFatHard){ fatG -= 0.05; remainingCal = targetCal - (protAdj*4 + fatG*9); }
      }
      carbG = Math.max(remainingCal/4, 0);
      return {bmr, tdee, targetCal, protG:round(protAdj,1), fatG:round(fatG,1), carbG:round(carbG,1), meals};
    }
    return {bmr, tdee, targetCal, protG:round(protG,1), fatG:round(fatG,1), carbG:round(carbG,1), meals};
  }

  function renderMacroTable(m){
    const rows = [
      {k:"Prote√≠na", g:m.protG, kcal: m.protG*4},
      {k:"Carbohidratos", g:m.carbG, kcal: m.carbG*4},
      {k:"Grasas", g:m.fatG, kcal: m.fatG*9},
    ];
    $('#macroTable').innerHTML = rows.map(r=>`
      <tr>
        <td>${r.k}</td>
        <td>${round(r.g,1)} g</td>
        <td>${round(r.kcal,0)} kcal</td>
        <td>${round(r.g/m.meals,1)} g</td>
      </tr>
    `).join("");
    $('#perMeals').textContent = m.meals;
    $('#results').style.display='block';
  }

  function updateBMI(){
    const w = +$('#weight').value || 0; const h = +$('#height').value || 0;
    if (!w || !h){ $('#bmi').value=""; return; }
    const {kg, cm} = toMetric(w,h); const m = cm/100; const bmi = kg / (m*m);
    $('#bmi').value = round(bmi,1);
  }

  function fillTips(goal){
    const tipSets = {
      cut: [
        "Apunta a 1.6‚Äì2.2 g/kg de prote√≠na para preservar masa muscular.",
        "Mant√©n grasas ‚â•0.5‚Äì0.6 g/kg para funci√≥n hormonal.",
        "Distribuye prote√≠na en 3‚Äì5 tomas; prioriza 25‚Äì40 g por comida.",
        "Alta saciedad: yogur griego, claras, pollo, at√∫n, legumbres, verduras fibrosas.",
        "Si el hambre es alta, sube ligeramente fibra y volumen (ensaladas, caldo)."
      ],
      recomp: [
        "Calor√≠as cercanas a TDEE y 1.6‚Äì2.0 g/kg de prote√≠na.",
        "Entrenamiento de fuerza progresivo 3‚Äì5x/sem; prioriza b√°sicos.",
        "Sue√±o 7‚Äì9 h. El descanso potencia recomposici√≥n.",
        "Monitorea per√≠metros adem√°s del peso; los cambios son sutiles."
      ],
      bulk: [
        "Super√°vit moderado (+8‚Äì15%) para minimizar ganancia de grasa.",
        "Prote√≠na 1.6‚Äì2.0 g/kg; carbohidratos como energ√≠a principal.",
        "Peri-entreno: carbohidratos y prote√≠na antes/despu√©s.",
        "Ajusta semanalmente: +100‚Äì150 kcal si no subes 0.25‚Äì0.5% de peso/sem."
      ]
    };
    $('#tips').innerHTML = tipSets[goal].map(t=>`<div class="chip">üí° <span>${t}</span></div>`).join("");
  }

  let MEAL = [];
  function findFoods(q){
    const db = loadDB(); if (!q) return db.slice(0,8);
    const s = q.toLowerCase(); return db.filter(it => it.name.toLowerCase().includes(s)).slice(0,10);
  }
  function renderSuggestions(list){ $('#foodSuggestions').innerHTML = list.map(it=>`<span class="tag">${it.name}</span>`).join(" "); }
  function foodByName(name){ return loadDB().find(it => it.name.toLowerCase()===name.toLowerCase()); }
  function addToMeal(name, grams){
    const f = foodByName(name); if (!f){ alert("No se encontr√≥ el alimento. A√±√°delo como personalizado."); return; }
    const factor = grams/100;
    const item = { name:f.name, grams, kcal: f.kcal*factor, p: f.p*factor, c: f.c*factor, f: f.f*factor };
    MEAL.push(item); renderMeal();
  }
  function renderMeal(){
    const rows = MEAL.map((it, idx)=>`
      <tr>
        <td>${it.name}</td>
        <td>${round(it.grams,0)}</td>
        <td>${round(it.kcal,0)}</td>
        <td>${round(it.p,1)}</td>
        <td>${round(it.c,1)}</td>
        <td>${round(it.f,1)}</td>
        <td><button data-i="${idx}" class="ghost rm">‚úñ</button></td>
      </tr>
    `).join("");
    $('#mealBody').innerHTML = rows || `<tr><td colspan="7" class="muted">A√∫n no hay alimentos en la comida.</td></tr>`;
    const tot = MEAL.reduce((a,x)=>({ grams:a.grams+x.grams, kcal:a.kcal+x.kcal, p:a.p+x.p, c:a.c+x.c, f:a.f+x.f }),{grams:0,kcal:0,p:0,c:0,f:0});
    $('#tQty').textContent = round(tot.grams,0); $('#tKcal').textContent = round(tot.kcal,0);
    $('#tP').textContent = round(tot.p,1); $('#tC').textContent = round(tot.c,1); $('#tF').textContent = round(tot.f,1);
    $$('#mealBody .rm').forEach(btn=>{ btn.onclick = ()=>{ MEAL.splice(+btn.dataset.i,1); renderMeal(); }; });
  }
  function saveMealLS(){
    const list = JSON.parse(localStorage.getItem("meals")||"[]");
    const stamp = new Date().toLocaleString();
    list.push({when:stamp, items:MEAL});
    localStorage.setItem("meals", JSON.stringify(list));
    loadMealsLS();
  }
  function loadMealsLS(){
    const list = JSON.parse(localStorage.getItem("meals")||"[]");
    if (!list.length){ $('#savedMealsWrap').style.display='none'; return; }
    $('#savedMealsWrap').style.display='block';
    $('#savedMeals').innerHTML = list.map((m,i)=>{
      const tot = m.items.reduce((a,x)=>({ grams:a.grams+x.grams, kcal:a.kcal+x.kcal, p:a.p+x.p, c:a.c+x.c, f:a.f+x.f }),{grams:0,kcal:0,p:0,c:0,f:0});
      return `
        <div class="card" style="margin:10px 0">
          <div class="row">
            <div><strong>Comida #${i+1}</strong> <span class="muted">(${m.when})</span></div>
            <div class="actions" style="justify-content:end">
              <button class="ghost" data-load="${i}">Cargar</button>
              <button class="ghost" data-del="${i}">Eliminar</button>
            </div>
          </div>
          <div class="kpi">
            <div class="pill"><strong>Cal:</strong> ${round(tot.kcal,0)}</div>
            <div class="pill"><strong>P:</strong> ${round(tot.p,1)} g</div>
            <div class="pill"><strong>C:</strong> ${round(tot.c,1)} g</div>
            <div class="pill"><strong>F:</strong> ${round(tot.f,1)} g</div>
          </div>
        </div>
      `;
    }).join("");
    $$('#savedMeals [data-load]').forEach(b=>{
      b.onclick = ()=>{
        const list = JSON.parse(localStorage.getItem("meals")||"[]");
        MEAL = JSON.parse(JSON.stringify(list[+b.dataset.load].items));
        renderMeal(); window.scrollTo({top:0,behavior:"smooth"});
      };
    });
    $$('#savedMeals [data-del]').forEach(b=>{
      b.onclick = ()=>{
        const list = JSON.parse(localStorage.getItem("meals")||"[]");
        list.splice(+b.dataset.del,1);
        localStorage.setItem("meals", JSON.stringify(list));
        loadMealsLS();
      };
    });
  }

  $('#units').onchange = ()=>{
    const metric = $('#units').value==='metric';
    document.querySelectorAll('.unit-h').forEach(e=>e.textContent = metric?'cm':'in');
    document.querySelectorAll('.unit-w').forEach(e=>e.textContent = metric?'kg':'lb');
    updateBMI();
  };
  $('#weight').oninput = updateBMI; $('#height').oninput = updateBMI;
  $('#goal').onchange = ()=>fillTips($('#goal').value);

  $('#calcTDEE').onclick = ()=>{
    const data = {
      sex: $('#sex').value,
      age: +$('#age').value, height:+$('#height').value, weight:+$('#weight').value,
      units: $('#units').value, activity: +$('#activity').value, goal: $('#goal').value,
      bfp: +$('#bfp').value || null, proteinMethod: $('#proteinMethod').value,
      minFat: +$('#minFat').value, meals:+$('#meals').value
    };
    if (!data.age || !data.height || !data.weight){ alert("Completa edad, altura y peso."); return; }
    const m = computeMacros(data);
    document.getElementById('kpiBMR').textContent = round(m.bmr,0);
    document.getElementById('kpiTDEE').textContent = round(m.tdee,0);
    document.getElementById('kpiTarget').textContent = round(m.targetCal,0);
    renderMacroTable(m);
  };

  document.getElementById('foodSearch').oninput = (e)=> renderSuggestions(findFoods(e.target.value));
  document.getElementById('addFood').onclick = ()=>{
    const q = document.getElementById('foodSearch').value.trim();
    const grams = +document.getElementById('qty').value;
    if (!q || !grams){ alert("Indica alimento y cantidad en gramos."); return; }
    const suggestion = findFoods(q)[0]; const name = suggestion ? suggestion.name : q;
    addToMeal(name, grams);
  };
  document.getElementById('newFood').onclick = ()=> document.querySelector('section:nth-of-type(4)').scrollIntoView({behavior:"smooth"});

  document.getElementById('addCustom').onclick = ()=>{
    const name = document.getElementById('cfName').value.trim();
    const kcal = +document.getElementById('cfKcal').value; const p = +document.getElementById('cfP').value; const c = +document.getElementById('cfC').value; const f = +document.getElementById('cfF').value;
    if (!name || [kcal,p,c,f].some(v=>isNaN(v))){ document.getElementById('customMsg').textContent="Completa todos los campos num√©ricos."; return; }
    saveCustomFood({name,kcal,p,c,f});
    document.getElementById('customMsg').textContent = `‚Äú${name}‚Äù a√±adido. Ya puedes buscarlo.`;
    document.getElementById('cfName').value=''; document.getElementById('cfKcal').value=250; document.getElementById('cfP').value=9; document.getElementById('cfC').value=45; document.getElementById('cfF').value=3;
    renderSuggestions(findFoods(document.getElementById('foodSearch').value));
  };

  document.getElementById('saveMeal').onclick = ()=>{ if (!MEAL.length){ alert("No hay alimentos en la comida."); return; } saveMealLS(); };
  document.getElementById('clearMeal').onclick = ()=>{ MEAL=[]; renderMeal(); };

  document.getElementById('saveProfile').onclick = ()=>{
    const data = {
      units: document.getElementById('units').value, sex: document.getElementById('sex').value, age: +document.getElementById('age').value,
      height: +document.getElementById('height').value, weight:+document.getElementById('weight').value,
      activity: +document.getElementById('activity').value, goal: document.getElementById('goal').value,
      bfp: +document.getElementById('bfp').value || null, proteinMethod: document.getElementById('proteinMethod').value,
      minFat: +document.getElementById('minFat').value, meals:+document.getElementById('meals').value
    };
    localStorage.setItem("profile", JSON.stringify(data));
    alert("Perfil guardado en este dispositivo.");
  };
  document.getElementById('resetAll').onclick = ()=>{
    if (!confirm("Esto borrar√° perfil, alimentos personalizados y comidas guardadas. ¬øContinuar?")) return;
    localStorage.removeItem("profile"); localStorage.removeItem("customFoods"); localStorage.removeItem("meals"); location.reload();
  };

  (function init(){
    const p = JSON.parse(localStorage.getItem("profile")||"null");
    if (p){
      document.getElementById('units').value = p.units||'metric';
      document.getElementById('sex').value = p.sex||'male';
      document.getElementById('age').value = p.age||'';
      document.getElementById('height').value = p.height||'';
      document.getElementById('weight').value = p.weight||'';
      document.getElementById('activity').value = p.activity||1.55;
      document.getElementById('goal').value = p.goal||'recomp';
      document.getElementById('bfp').value = p.bfp??'';
      document.getElementById('proteinMethod').value = p.proteinMethod||'bw1.8';
      document.getElementById('minFat').value = p.minFat||0.6;
      document.getElementById('meals').value = p.meals||3;
    }
    const consent = localStorage.getItem('cookieConsent');
    if(!consent){ document.getElementById('cookieBanner').style.display='block'; }
    document.getElementById('cookieAccept').onclick = function(){ localStorage.setItem('cookieConsent','accepted'); document.getElementById('cookieBanner').style.display='none'; };
    document.getElementById('cookieDecline').onclick = function(){ localStorage.setItem('cookieConsent','declined'); document.getElementById('cookieBanner').style.display='none'; };

    fillTips(document.getElementById('goal').value || 'recomp');
  })();
  </script>
</body>
</html>
