<!DOCTYPE html>
codex/refactorizar-logica-en-modulos
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ProteeMVT — Calculadora & Registro de Macros</title>
  </head>
  <body>
    <div id="app">Aplicación ProteeMVT</div>
    <script type="module" src="/src/main.js"></script>
  </body>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProteeMVT — Calculadora & Registro de Macros</title>
  <meta name="description" content="Calcula tus macros, registra tus comidas y mide tu avance con una experiencia rápida y confiable." />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#ffffff" />
  <meta property="og:title" content="ProteeMVT — Calculadora & Registro de Macros" />
  <meta property="og:description" content="Calcula tus macros, guarda tus metas y registra tus comidas con una experiencia rápida, accesible y confiable." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="/og-preview.png" />
  <meta property="og:locale" content="es_ES" />
  <meta name="twitter:card" content="summary_large_image" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://dnygudxhimjksxedzckl.supabase.co; font-src https://fonts.gstatic.com; img-src 'self' data:; object-src 'none'">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/styles.css">
  </head>
<body>
  <header id="topbar" class="hide" role="banner">
    <div class="tb" aria-label="Barra superior">
      <div class="pill" aria-hidden="true">ProteeMVT</div>
      <div class="row" style="align-items:center">
        <span id="userBadge" class="muted" aria-live="polite"></span>
        <button id="btnProfile" class="btn btn-soft" type="button" aria-haspopup="dialog" aria-controls="profileModal">Tu perfil</button>
        <button id="btnHeaderLogout" class="btn" type="button">Salir</button>
      </div>
    </div>
  </header>

  <section id="hero-guest" class="hero" aria-labelledby="heroGuestTitle">
    <div class="wrap hero-pad">
      <div class="hero-grid">
        <div>
          <h1 id="heroGuestTitle" class="display">Nutrición simple, progreso real</h1>
          <p class="lead">Calcula tus macros, guarda tus metas diarias y registra tus comidas sin fricción.</p>
        </div>
        <aside class="card" aria-labelledby="accessTitle">
          <h2 id="accessTitle" style="margin:0 0 10px;font-size:22px;color:#0e3e34">Acceso</h2>
          <p class="muted" style="margin:0 0 10px">Elige una opción para continuar.</p>
          <div class="stack-10">
            <button id="btnOpenSignup" class="btn btn-primary" type="button">Regístrate</button>
            <button id="btnOpenLogin" class="btn btn-soft" type="button">Iniciar sesión</button>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <main class="wrap" id="main">
    <section id="dashboard" class="hide" aria-label="Panel de usuario" style="margin-top:6px">
      <h2>Bienvenido</h2>
      <nav class="tabs" aria-label="Secciones del panel">
        <button data-tab="resumen" aria-current="page">Resumen</button>
        <button data-tab="calculadora">Calculadora de macros</button>
        <button data-tab="comidas">Comidas</button>
        <button data-tab="progreso">Progreso</button>
      </nav>

      <section id="resumen" class="stack-12">
        <div class="grid-3">
          <div class="card stack-12">
            <h3 style="margin:0">Metas de hoy</h3>
            <div class="stack-8">
              <div>
                <div class="row" style="justify-content:space-between"><strong>Calorías</strong><span id="sumCalGoal">—</span></div>
                <div class="bar" aria-hidden="true"><span id="barCal"></span></div>
                <div class="row" style="justify-content:space-between" aria-live="polite"><small class="muted">Consumidas</small><small id="sumCalIn">0</small></div>
              </div>
              <div>
                <div class="row" style="justify-content:space-between"><strong>Proteínas (g)</strong><span id="sumProtGoal">—</span></div>
                <div class="bar"><span id="barProt"></span></div>
                <div class="row" style="justify-content:space-between"><small class="muted">Consumidas</small><small id="sumProtIn">0</small></div>
              </div>
              <div>
                <div class="row" style="justify-content:space-between"><strong>Carbohidratos (g)</strong><span id="sumCarbGoal">—</span></div>
                <div class="bar"><span id="barCarb"></span></div>
                <div class="row" style="justify-content:space-between"><small class="muted">Consumidos</small><small id="sumCarbIn">0</small></div>
              </div>
              <div>
                <div class="row" style="justify-content:space-between"><strong>Grasas (g)</strong><span id="sumFatGoal">—</span></div>
                <div class="bar"><span id="barFat"></span></div>
                <div class="row" style="justify-content:space-between"><small class="muted">Consumidas</small><small id="sumFatIn">0</small></div>
              </div>
            </div>
          </div>
          <div class="card stack-12">
            <h3 style="margin:0">Atajos</h3>
            <div class="row">
              <button id="btnQuickAdd" class="btn btn-primary" type="button">+ Añadir comida</button>
              <button id="btnSetTodayTargets" class="btn" type="button">Aplicar metas guardadas</button>
            </div>
            <p class="muted">Consejo: guarda tus alimentos frecuentes para registrarlos en 2 clics.</p>
          </div>
          <div class="card stack-12">
            <h3 style="margin:0">Metas guardadas</h3>
            <div class="stack-8">
              <div class="row" style="gap:8px">
                <span class="pill">Mantenimiento</span>
                <span class="pill">Déficit leve</span>
                <span class="pill">Superávit leve</span>
              </div>
              <p class="muted">Puedes recalcular desde la Calculadora y guardar como preset.</p>
            </div>
          </div>
        </div>
      </section>

      <section id="calculadora" class="stack-16 hide" aria-labelledby="calcTitle">
        <h3 id="calcTitle" style="margin:0">Calculadora de macros</h3>
        <form id="macroForm" class="card stack-12" novalidate>
          <div class="grid-3">
            <div>
              <label for="sex">Sexo</label>
              <select id="sex" required>
                <option value="" disabled selected>Selecciona…</option>
                <option value="male">Masculino</option>
                <option value="female">Femenino</option>
              </select>
            </div>
            <div>
              <label for="age">Edad (años)</label>
              <input id="age" type="number" min="10" max="100" inputmode="numeric" placeholder="30" required />
            </div>
            <div>
              <label for="height">Estatura (cm)</label>
              <input id="height" type="number" min="120" max="230" inputmode="numeric" placeholder="175" required />
            </div>
            <div>
              <label for="weight">Peso (kg)</label>
              <input id="weight" type="number" min="30" max="250" step="0.1" inputmode="decimal" placeholder="75" required />
            </div>
            <div>
              <label for="activity">Actividad</label>
              <select id="activity" required>
                <option value="" disabled selected>Selecciona…</option>
                <option value="1.2">Sedentario</option>
                <option value="1.375">Ligero (1-3 d/sem)</option>
                <option value="1.55">Moderado (3-5 d/sem)</option>
                <option value="1.725">Intenso (6-7 d/sem)</option>
                <option value="1.9">Muy intenso (atleta)</option>
              </select>
            </div>
            <div>
              <label for="goal">Objetivo</label>
              <select id="goal" required>
                <option value="maintain">Mantener</option>
                <option value="deficit">Déficit (−10%)</option>
                <option value="surplus">Superávit (+10%)</option>
              </select>
            </div>
          </div>
          <div class="grid-3">
            <div>
              <label for="protein">Proteína (g/kg)</label>
              <input id="protein" type="number" step="0.1" min="1.4" max="2.6" value="2.0" required />
            </div>
            <div>
              <label for="fatPct">Grasa (% kcal)</label>
              <input id="fatPct" type="number" step="1" min="20" max="35" value="30" required />
            </div>
            <div class="row" style="align-items:flex-end">
              <button id="btnCalc" type="submit" class="btn btn-primary">Calcular</button>
              <button id="btnSavePreset" type="button" class="btn">Guardar preset</button>
            </div>
          </div>
          <p id="calcMsg" class="muted" role="status" aria-live="polite"></p>
          <div id="calcOut" class="grid-3 hide" aria-live="polite">
            <div class="card"><strong>Calorías día</strong><div id="outKcal" style="font-size:28px;margin-top:6px">—</div></div>
            <div class="card"><strong>Proteínas</strong><div id="outProt" style="font-size:28px;margin-top:6px">—</div><small class="muted">(4 kcal/g)</small></div>
            <div class="card"><strong>Grasas</strong><div id="outFat" style="font-size:28px;margin-top:6px">—</div><small class="muted">(9 kcal/g)</small></div>
            <div class="card"><strong>Carbohidratos</strong><div id="outCarb" style="font-size:28px;margin-top:6px">—</div><small class="muted">(4 kcal/g)</small></div>
            <div class="card"><strong>Fibra recomendada</strong><div id="outFiber" style="font-size:20px;margin-top:6px">—</div><small class="muted">14 g por cada 1000 kcal</small></div>
          </div>
        </form>
      </section>

      <section id="comidas" class="hide stack-16" aria-labelledby="foodsTitle">
        <h3 id="foodsTitle" style="margin:0">Registro de comidas</h3>
        <div class="grid-2">
          <form id="foodForm" class="card stack-12" novalidate>
            <h4 style="margin:0">Agregar alimento</h4>
            <div class="grid-2">
              <div>
                <label for="fName">Nombre</label>
                <input id="fName" type="text" placeholder="Yogurt griego natural" required />
              </div>
              <div>
                <label for="fBrand">Marca (opcional)</label>
                <input id="fBrand" type="text" placeholder="Laive" />
              </div>
            </div>
            <div class="grid-3">
              <div>
                <label for="fServing">Ración (g/ml)</label>
                <input id="fServing" type="number" min="1" step="1" placeholder="170" required />
              </div>
              <div>
                <label for="fKcal">Kcal x ración</label>
                <input id="fKcal" type="number" min="0" step="1" placeholder="120" required />
              </div>
              <div>
                <label for="fProtein">Prot (g)</label>
                <input id="fProtein" type="number" min="0" step="0.1" placeholder="17" required />
              </div>
              <div>
                <label for="fCarb">Carb (g)</label>
                <input id="fCarb" type="number" min="0" step="0.1" placeholder="6" required />
              </div>
              <div>
                <label for="fFat">Grasa (g)</label>
                <input id="fFat" type="number" min="0" step="0.1" placeholder="0" required />
              </div>
              <div>
                <label for="fFiber">Fibra (g)</label>
                <input id="fFiber" type="number" min="0" step="0.1" placeholder="0" />
              </div>
            </div>
            <div class="row" style="justify-content:space-between">
              <button id="btnSaveFood" type="submit" class="btn btn-primary">Guardar alimento</button>
              <div class="row">
                <label for="logQty">Registrar</label>
                <input id="logQty" type="number" min="0.25" step="0.25" value="1" style="width:90px" />
                <button id="btnLogFood" type="button" class="btn">+ al diario</button>
              </div>
            </div>
            <p id="foodMsg" class="muted" role="status" aria-live="polite"></p>
          </form>

          <div class="card stack-12">
            <div class="row" style="justify-content:space-between; align-items:center">
              <h4 style="margin:0">Tus alimentos guardados</h4>
              <input id="foodSearch" type="search" placeholder="Buscar…" style="max-width:260px" />
            </div>
            <table aria-label="Alimentos guardados">
              <thead>
                <tr><th>Alimento</th><th>Ración</th><th>Kcal</th><th>Prot</th><th>Carb</th><th>Grasa</th><th></th></tr>
              </thead>
              <tbody id="foodsTable"></tbody>
            </table>
          </div>
        </div>

        <div class="card stack-12">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h4 style="margin:0">Diario de hoy <span id="todayLabel" class="muted"></span></h4>
            <div class="row">
              <button id="btnClearDay" class="btn" type="button">Limpiar</button>
            </div>
          </div>
          <table aria-label="Diario de hoy">
            <thead>
            <tr><th>Alimento</th><th>Ración</th><th>Cantidad</th><th>Kcal</th><th>Prot</th><th>Carb</th><th>Grasa</th><th></th></tr>
            </thead>
            <tbody id="dayTable"></tbody>
            <tfoot>
              <tr>
                <th class="right" colspan="3">Totales</th>
                <th id="totKcal">0</th><th id="totProt">0</th><th id="totCarb">0</th><th id="totFat">0</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <section id="progreso" class="hide stack-12" aria-labelledby="progTitle">
        <h3 id="progTitle" style="margin:0">Progreso</h3>
        <div class="card stack-12">
          <p class="muted">Resumen semanal de adherencia (calorías consumidas vs meta).</p>
          <div id="adherence" class="stack-12"></div>
        </div>
      </section>

      <div class="center" style="margin-top:14px">
        <button class="btn" type="button" id="btnLogout">Cerrar sesión</button>
      </div>
    </section>
  </main>

  <!-- MODALES: Signup / Login / Perfil -->
  <div id="signupModal" class="hide" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
    <section class="modal">
      <div class="card" style="max-width:460px;width:100%">
        <h2 id="signupTitle">Crear cuenta</h2>
        <div class="stack-12" style="margin-top:8px">
          <div>
            <label for="suEmail">Correo</label>
            <input id="suEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email" required />
          </div>
          <div>
            <label for="suPass">Contraseña</label>
            <input id="suPass" type="password" placeholder="Mínimo 6 caracteres" autocomplete="new-password" required />
          </div>
        </div>
        <p id="suMsg" class="muted" style="margin-top:8px" role="status" aria-live="polite"></p>
        <div class="row" style="margin-top:12px;justify-content:flex-end">
          <button id="btnCloseSignup" class="btn" type="button">Cancelar</button>
          <button id="btnDoSignup" class="btn btn-primary" type="button">Crear cuenta</button>
        </div>
      </div>
    </section>
  </div>

  <div id="loginModal" class="hide" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <section class="modal">
      <div class="card" style="max-width:460px;width:100%">
        <h2 id="loginTitle">Iniciar sesión</h2>
        <div class="stack-12" style="margin-top:8px">
          <div>
            <label for="liEmail">Correo</label>
            <input id="liEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email" required />
          </div>
          <div>
            <label for="liPass">Contraseña</label>
            <input id="liPass" type="password" placeholder="Tu contraseña" autocomplete="current-password" required />
          </div>
        </div>
        <p id="liMsg" class="muted" style="margin-top:8px" role="status" aria-live="polite"></p>
        <div class="row" style="margin-top:12px;justify-content:space-between">
          <button id="btnForgot" class="btn btn-soft" type="button">Olvidé mi contraseña</button>
          <div>
            <button id="btnCloseLogin" class="btn" type="button">Cancelar</button>
            <button id="btnDoLogin" class="btn btn-primary" type="button">Entrar</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="profileModal" class="hide" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
    <section class="modal">
      <div class="card" style="max-width:460px;width:100%">
        <h2 id="profileTitle">Tu perfil</h2>
        <p class="muted" style="margin-top:4px">Tu correo y nombre visible dentro de la app.</p>
        <div class="stack-12" style="margin-top:10px">
          <div>
            <label for="profEmail">Correo</label>
            <input id="profEmail" type="email" disabled />
          </div>
          <div>
            <label for="profName">Nombre visible</label>
            <input id="profName" type="text" placeholder="Tu nombre" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:flex-end">
          <button id="btnCloseProfile" class="btn" type="button">Cerrar</button>
          <button id="btnSaveProfile" class="btn btn-primary" type="button">Guardar</button>
        </div>
        <p id="profMsg" class="muted" style="margin-top:8px" role="status" aria-live="polite"></p>
      </div>
    </section>
  </div>

  <footer class="wrap" aria-label="Información legal">
    <p class="muted">© <span id="year"></span> ProteeMVT. Todos los derechos reservados.</p>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

codex/move-supabase-variables-to-environment
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"
    integrity="sha384-OLBgp1GsljhM2TJ+sbHjaiH9txEUvgdDTAzHv2P24donTt6/529l+9Ua0vFImLlb"
    crossorigin="anonymous"></script>
  <script src="/api/env.js"></script>
  <script>
  const { createClient } = supabase;
  const SUPABASE_URL = window.env.SUPABASE_URL;
  const SUPABASE_ANON_KEY = window.env.SUPABASE_ANON_KEY;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const $ = (id)=>document.getElementById(id);
  const show = (id)=>$(id).classList.remove('hide');
  const hide = (id)=>$(id).classList.add('hide');
  const fmt = (n,d=0)=>Number(n||0).toLocaleString('es-PE',{maximumFractionDigits:d,minimumFractionDigits:d});
  const todayKey = ()=> new Date().toISOString().slice(0,10);
  const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2600); };
  const LS = { get:(k,f)=>{ try{ return JSON.parse(localStorage.getItem(k))??f }catch{ return f } }, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)), del:(k)=>localStorage.removeItem(k) };

  // --- Perfil
  async function getUser(){ const { data:{ user } } = await sb.auth.getUser(); return user||null; }
  async function getProfile(userId){ const { data, error } = await sb.from('profiles').select('*').eq('id', userId).maybeSingle(); if(error){ console.warn('profiles select', error.message); return null } return data||null }
  async function ensureProfile(){ const user = await getUser(); if(!user) return null; let prof = await getProfile(user.id); if(!prof){ const { error } = await sb.from('profiles').insert({ id:user.id, display_name:user.email }); if(error) console.warn('profiles insert', error.message); prof = await getProfile(user.id) } return prof }
  function setLoggedUI(user){ show('topbar'); hide('hero-guest'); show('dashboard'); $('userBadge').textContent=user.email }
  function setGuestUI(){ hide('topbar'); show('hero-guest'); hide('dashboard') }

  // --- Auth flows
  async function doSignup(){ const email=($('suEmail').value||'').trim(); const password=$('suPass').value||''; const btn=$('btnDoSignup'); const msg=$('suMsg'); msg.textContent=''; if(!email||!password||password.length<6){ msg.textContent='Completa correo y una contraseña de al menos 6 caracteres.'; return } btn.disabled=true; try{ const { error }=await sb.auth.signUp({ email, password, options:{ emailRedirectTo: window.location.origin } }); if(error) throw error; msg.textContent='Cuenta creada. Verifica tu correo y luego inicia sesión.' }catch(err){ msg.textContent='Error: '+(err?.message||'No se pudo crear la cuenta') } finally{ btn.disabled=false } }
  async function doLogin(){ const email=($('liEmail').value||'').trim(); const password=$('liPass').value||''; const btn=$('btnDoLogin'); const msg=$('liMsg'); msg.textContent=''; if(!email||!password){ msg.textContent='Ingresa tu correo y contraseña.'; return } btn.disabled=true; try{ const { error }=await sb.auth.signInWithPassword({ email, password }); if(error) throw error }catch(err){ msg.textContent='Error de acceso: '+(err?.message||'verifica tus datos') } finally{ btn.disabled=false } }
  async function doForgot(){ const email=($('liEmail').value||'').trim(); const msg=$('liMsg'); if(!email){ msg.textContent='Escribe tu correo para enviarte el enlace de recuperación.'; return } try{ const { error }=await sb.auth.resetPasswordForEmail(email,{ redirectTo: window.location.origin+'#type=recovery' }); if(error) throw error; msg.textContent='Te enviamos un enlace para reestablecer tu contraseña.' }catch(err){ msg.textContent='No se pudo enviar el correo: '+(err?.message||'intenta de nuevo') } }

  // --- Tabs
  const tabs=['resumen','calculadora','comidas','progreso'];
  function setTab(name){ tabs.forEach(id=>{ const btn=document.querySelector(`button[data-tab="${id}"]`); const sec=$(id); const active=id===name; if(btn) btn.setAttribute('aria-current', active?'page':'false'); if(sec) sec.classList.toggle('hide', !active); }) }

  // --- Cálculo macros
  function mifflinStJeor({sex,age,height,weight}){ const s=sex==='male'?5:-161; return (10*weight)+(6.25*height)-(5*age)+s }
  function tdee({bmr,activity}){ return bmr*activity }
  function goalAdj(kcal,goal){ if(goal==='deficit') return kcal*0.90; if(goal==='surplus') return kcal*1.10; return kcal }
  function splitMacros({weight,kcal,proteinGPerKg,fatPct}){ const pG=proteinGPerKg*weight; const pKcal=pG*4; const fKcal=(fatPct/100)*kcal; const fG=fKcal/9; const cKcal=Math.max(kcal-pKcal-fKcal,0); const cG=cKcal/4; const fiber=Math.round((kcal/1000)*14); return {kcal:Math.round(kcal),pG:Math.round(pG),cG:Math.round(cG),fG:Math.round(fG),fiber} }
  function calcAndRender(){ const sex=$('sex').value, age=+$('age').value, height=+$('height').value, weight=+$('weight').value; const activity=+$('activity').value, goal=$('goal').value; const proteinGPerKg=+$('protein').value, fatPct=+$('fatPct').value; if(!sex||!age||!height||!weight||!activity||!goal||!proteinGPerKg||!fatPct){ $('calcMsg').textContent='Completa todos los campos.'; return } if(fatPct<15||fatPct>40){ $('calcMsg').textContent='El % de grasa debe estar entre 15% y 40%.'; return } const bmr=mifflinStJeor({sex,age,height,weight}); const kcal=goalAdj(tdee({bmr,activity}),goal); const out=splitMacros({weight,kcal,proteinGPerKg,fatPct}); $('outKcal').textContent=fmt(out.kcal); $('outProt').textContent=`${fmt(out.pG)} g`; $('outCarb').textContent=`${fmt(out.cG)} g`; $('outFat').textContent=`${fmt(out.fG)} g`; $('outFiber').textContent=`${fmt(out.fiber)} g`; show('calcOut'); $('calcMsg').textContent='Cálculo actualizado ✅'; LS.set('last_calc',{sex,age,height,weight,activity,goal,proteinGPerKg,fatPct,out,ts:Date.now()}) }

  // --- Foods & Diary
  function escapeHtml(s){ return (s||'').replace(/[&<>"'\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#x27;','/':'&#x2F;'}[c])) }
  function normalizeFood(f){ return { id:f.id||crypto.randomUUID(), name:(f.name||'').trim(), brand:(f.brand||'').trim(), serving:+f.serving, kcal:+f.kcal, p:+f.p, c:+f.c, g:+f.g, fi:+f.fi } }
  function saveFoodLocal(food){ const list=LS.get('foods',[]); const idx=list.findIndex(x=>x.name.toLowerCase()===food.name.toLowerCase() && x.brand.toLowerCase()===food.brand.toLowerCase()); if(idx>-1) list[idx]=food; else list.unshift(food); LS.set('foods',list); return food }
  async function saveFoodSupabase(food){ try{ const user=await getUser(); if(!user) return; await sb.from('foods').upsert({ user_id:user.id, food }) }catch(err){ console.warn('foods upsert', err?.message) } }
  function renderFoods(filter=''){ const tbody=$('foodsTable'); tbody.innerHTML=''; const list=LS.get('foods',[]); const q=(filter||'').toLowerCase(); list.filter(x=>x.name.toLowerCase().includes(q)||x.brand.toLowerCase().includes(q)).slice(0,200).forEach(f=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><strong>${escapeHtml(f.name)}</strong> <small class="muted">${escapeHtml(f.brand||'')}</small></td><td>${fmt(f.serving)} g</td><td>${fmt(f.kcal)}</td><td>${fmt(f.p,1)}</td><td>${fmt(f.c,1)}</td><td>${fmt(f.g,1)}</td><td class="right"><button class="btn btn-soft" data-add="${f.id}">+ diario</button></td>`; tbody.appendChild(tr) }) }
  function logToDay(food,qty){ const key='day:'+todayKey(); const rows=LS.get(key,[]); rows.push({ id:crypto.randomUUID(), fid:food.id, name:food.name, brand:food.brand, serving:food.serving, qty, kcal:food.kcal*qty, p:food.p*qty, c:food.c*qty, g:food.g*qty }); LS.set(key,rows); renderDay(); renderSummary() }
  function removeFromDay(id){ const key='day:'+todayKey(); const rows=LS.get(key,[]).filter(r=>r.id!==id); LS.set(key,rows); renderDay(); renderSummary() }
  function totals(rows){ return rows.reduce((a,r)=>({kcal:a.kcal+r.kcal,p:a.p+r.p,c:a.c+r.c,g:a.g+r.g}),{kcal:0,p:0,c:0,g:0}) }
  function renderDay(){ $('todayLabel').textContent=todayKey(); const key='day:'+todayKey(); const rows=LS.get(key,[]); const tbody=$('dayTable'); tbody.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><strong>${escapeHtml(r.name)}</strong> <small class="muted">${escapeHtml(r.brand||'')}</small></td><td>${fmt(r.serving)} g</td><td>${fmt(r.qty,2)}</td><td>${fmt(r.kcal)}</td><td>${fmt(r.p,1)}</td><td>${fmt(r.c,1)}</td><td>${fmt(r.g,1)}</td><td class="right"><button class="btn" data-del="${r.id}">Eliminar</button></td>`; tbody.appendChild(tr) }); const t=totals(rows); $('totKcal').textContent=fmt(t.kcal); $('totProt').textContent=fmt(t.p,1); $('totCarb').textContent=fmt(t.c,1); $('totFat').textContent=fmt(t.g,1) }
  function renderSummary(){ const key='day:'+todayKey(); const rows=LS.get(key,[]); const t=totals(rows); const targets=LS.get('targets:'+todayKey(),null); let kcal=0,p=0,c=0,g=0; if(targets){ kcal=targets.kcal; p=targets.pG; c=targets.cG; g=targets.fG } $('sumCalGoal').textContent=kcal?fmt(kcal):'—'; $('sumProtGoal').textContent=p?fmt(p):'—'; $('sumCarbGoal').textContent=c?fmt(c):'—'; $('sumFatGoal').textContent=g?fmt(g):'—'; $('sumCalIn').textContent=fmt(t.kcal); $('sumProtIn').textContent=fmt(t.p,1); $('sumCarbIn').textContent=fmt(t.c,1); $('sumFatIn').textContent=fmt(t.g,1); const pct=(v,goal)=>!goal?0:Math.min(Math.round((v/goal)*100),100); $('barCal').style.width=pct(t.kcal,kcal)+'%'; $('barProt').style.width=pct(t.p,p)+'%'; $('barCarb').style.width=pct(t.c,c)+'%'; $('barFat').style.width=pct(t.g,g)+'%' }
  function renderAdherence(){ const host=$('adherence'); host.innerHTML=''; const days=[...Array(7).keys()].map(i=>{ const d=new Date(); d.setDate(d.getDate()-i); return d.toISOString().slice(0,10) }).reverse(); const frag=document.createDocumentFragment(); days.forEach(d=>{ const rows=LS.get('day:'+d,[]); const t=totals(rows); const targets=LS.get('targets:'+d,null)||LS.get('targets:'+todayKey(),null); const kcalTarget=targets?.kcal||2000; const pct=Math.min(Math.round((t.kcal/kcalTarget)*100),130); const wrap=document.createElement('div'); wrap.className='stack-8'; wrap.innerHTML=`<div class="row" style="justify-content:space-between"><strong>${d}</strong><small class="muted">${fmt(t.kcal)} / ${fmt(kcalTarget)} kcal</small></div><div class="bar"><span style="width:${pct}%"></span></div>`; frag.appendChild(wrap) }); host.appendChild(frag) }

  // --- UI Events
  document.addEventListener('click',(e)=>{ const t=e.target; if(t.matches('nav.tabs button')) setTab(t.dataset.tab); if(t.id==='btnLogout'||t.id==='btnHeaderLogout') logout(); if(t.id==='btnOpenSignup') openModal('signupModal'); if(t.id==='btnOpenLogin') openModal('loginModal'); if(t.id==='btnCloseSignup') closeModal('signupModal'); if(t.id==='btnCloseLogin') closeModal('loginModal'); if(t.id==='btnProfile') openProfileModal(); if(t.id==='btnCloseProfile') closeModal('profileModal'); if(t.dataset.add){ const f=LS.get('foods',[]).find(x=>x.id===t.dataset.add); const qty=parseFloat($('logQty').value||'1')||1; if(f){ logToDay(f,qty); toast('Registrado en el diario.') } } if(t.dataset.del) removeFromDay(t.dataset.del); if(t.id==='btnClearDay'){ if(confirm('¿Seguro de limpiar el diario de hoy?')){ LS.set('day:'+todayKey(),[]); renderDay(); renderSummary() } } if(t.id==='btnQuickAdd'){ setTab('comidas'); $('fName').focus() } if(t.id==='btnDoSignup') doSignup(); if(t.id==='btnDoLogin') doLogin(); if(t.id==='btnForgot') doForgot(); });
  $('foodSearch').addEventListener('input',()=>renderFoods($('foodSearch').value));
  $('macroForm').addEventListener('submit',(e)=>{ e.preventDefault(); calcAndRender() });
  $('btnSavePreset').addEventListener('click', async ()=>{ const last=LS.get('last_calc'); if(!last){ toast('Primero calcula tus macros.'); return } const presets=LS.get('presets',[]); presets.unshift({ id:crypto.randomUUID(), ...last }); LS.set('presets',presets); toast('Preset guardado.'); try{ const user=await getUser(); if(user){ await sb.from('macro_presets').insert({ user_id:user.id, payload:last }) } }catch(err){ console.warn('macro_presets insert',err?.message) } });
  $('btnSetTodayTargets').addEventListener('click',()=>{ const last=LS.get('last_calc'); if(!last){ toast('Primero calcula y guarda un preset.'); return } LS.set('targets:'+todayKey(), last.out); toast('Metas de hoy actualizadas.'); renderSummary() });
  $('foodForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const food=normalizeFood({ name:$('fName').value, brand:$('fBrand').value, serving:$('fServing').value, kcal:$('fKcal').value, p:$('fProtein').value, c:$('fCarb').value, g:$('fFat').value, fi:$('fFiber').value }); if(!food.name||!food.serving){ $('foodMsg').textContent='Completa al menos nombre y ración.'; return } saveFoodLocal(food); renderFoods($('foodSearch').value); $('foodMsg').textContent='Alimento guardado ✅'; try{ await saveFoodSupabase(food) }catch{} });
  $('btnLogFood').addEventListener('click',()=>{ const food=normalizeFood({ name:$('fName').value, brand:$('fBrand').value, serving:$('fServing').value, kcal:$('fKcal').value, p:$('fProtein').value, c:$('fCarb').value, g:$('fFat').value, fi:$('fFiber').value }); if(!food.name||!food.serving){ $('foodMsg').textContent='Completa al menos nombre y ración.'; return } saveFoodLocal(food); const qty=parseFloat($('logQty').value||'1')||1; logToDay(food,qty); toast('Registrado en el diario.'); renderFoods($('foodSearch').value) });

  // --- Modales & sesión
  function openModal(id){ show(id); document.body.style.overflow='hidden' }
  function closeModal(id){ hide(id); document.body.style.overflow='' }
  async function openProfileModal(){ const user=await getUser(); if(!user) return; const profile=await getProfile(user.id); $('profEmail').value=user.email||''; $('profName').value=profile?.display_name||''; openModal('profileModal') }
  $('btnSaveProfile').addEventListener('click', async ()=>{ const user=await getUser(); if(!user) return; const display_name=( $('profName').value||'' ).trim()||user.email; const { error }=await sb.from('profiles').upsert({ id:user.id, display_name }); $('profMsg').textContent= error?('Error: '+error.message):'Guardado ✅' });
  async function logout(){ await sb.auth.signOut(); setGuestUI(); toast('Sesión cerrada') }

  // --- Boot
  (async ()=>{
    $('year').textContent=new Date().getFullYear();
    const hash=window.location.hash||"";
    if(hash.includes('access_token')&&hash.includes('refresh_token')){ const p=new URLSearchParams(hash.substring(1)); await sb.auth.setSession({ access_token:p.get('access_token'), refresh_token:p.get('refresh_token') }); history.replaceState({},document.title,window.location.pathname) }
    if(hash.includes('type=recovery')) openModal('loginModal');

    sb.auth.onAuthStateChange(async (event, session)=>{ const user=session?.user||null; if(user){ setLoggedUI(user); await ensureProfile(); closeModal('loginModal'); closeModal('signupModal'); toast('Sesión iniciada') } else { setGuestUI() } });

    const { data:{ user } } = await sb.auth.getUser();
    if(user){ setLoggedUI(user); await ensureProfile() } else { setGuestUI() }
    setTab('resumen'); renderFoods(''); renderDay(); renderSummary(); renderAdherence();
  })();
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="/app.js" type="module"></script>
 main
</body>
main
</html>
