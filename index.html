<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prouti ‚Äî Nutrici√≥n simple, progreso real</title>
  <meta name="description" content="Calcula tus macros, registra lo que comes y mide tu avance." />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#12d59a" />

  <!-- Social -->
  <meta property="og:title" content="Prouti ‚Äî Nutrici√≥n simple, progreso real" />
  <meta property="og:description" content="Calcula tus macros, registra lo que comes y mide tu avance." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="/og-preview.png" />
  <meta property="og:locale" content="es_ES" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Tipograf√≠as redondeadas -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Rubik+Rounded:wght@400;500;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --emerald:#10b981;   /* primario */
      --aqua:#32e6ff;      /* acento */
      --ink:#0b1a20;       /* texto principal */
      --ink-2:#355059;     /* texto secundario */
      --paper:#f4fff9;     /* fondo */
      --glass:#ffffff;     /* superficies */
      --stroke: rgba(12,130,94,.14);
      --ring: rgba(18,213,154,.22);
      --shadow: 0 14px 34px rgba(5,28,22,.08), 0 4px 14px rgba(5,28,22,.06);
      --radius-xl: 22px; --radius:16px; --radius-sm:12px;
      --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:'Rubik Rounded','Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      color:var(--ink);
      background:
        /* textura sutil de puntitos */
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cg fill='%23e2f7ee' fill-opacity='0.85'%3E%3Ccircle cx='6' cy='6' r='1'/%3E%3Ccircle cx='42' cy='58' r='1'/%3E%3Ccircle cx='96' cy='22' r='1'/%3E%3Ccircle cx='86' cy='100' r='1'/%3E%3Ccircle cx='18' cy='88' r='1'/%3E%3C/g%3E%3C/svg%3E") repeat,
        linear-gradient(180deg, #ffffff 0%, var(--paper) 100%);
      min-height:100dvh;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:0 20px 72px; }

    /* ===== Header fijo (logo + nombre) ===== */
    header.site{ position:sticky; top:0; z-index:40; background:rgba(255,255,255,.86); backdrop-filter:saturate(140%) blur(8px); border-bottom:1px solid #e9f3ee }
    .site-inner{ max-width:1200px; margin:0 auto; padding:10px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit }
    .logo{ width:28px; height:28px; border-radius:9px; position:relative; background:
      conic-gradient(from 210deg, #16d39f, #13c6df, #b4ff63, #16d39f);
      box-shadow:0 6px 18px rgba(16,185,129,.28);
    }
    .logo::after{ content:""; position:absolute; inset:3px; border-radius:7px; background:linear-gradient(180deg,#fff,rgba(255,255,255,.65)); mix-blend-mode:overlay; opacity:.7 }
    .brand-name{ font-weight:800; letter-spacing:.2px }

    .site-actions{ display:flex; gap:8px; align-items:center }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; background:#f1fcf7; border:1px solid #e2f5ee; border-radius:999px; color:#0a3a30; font-weight:700 }

    /* Botones & Inputs */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 16px; border-radius:999px; border:1px solid var(--stroke); background:#ffffff; color:#0f2a23; font-weight:800; cursor:pointer; transition: transform .06s ease, box-shadow .18s ease, filter .18s ease; }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ background:linear-gradient(135deg,#16d39f,#0fb787); color:#04241b; border-color:transparent; box-shadow: 0 12px 26px rgba(16,185,129,.26), inset 0 -2px 0 rgba(0,0,0,.06); }
    .btn-primary:hover{ filter:brightness(1.03) }
    .btn-soft{ background:#f3fbf8; border-color:#e3f3ed }
    .btn-danger{ background:#ffecec; border-color:#ffd1d1; color:#9f1b1b }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }

    label{ font-weight:700; font-size:13px; display:inline-block; margin-bottom:6px; letter-spacing:.2px }
    input{ width:100%; padding:15px 16px; border-radius:16px; border:1px solid #e5efea; background:#fff; font-size:16px; outline:none; transition:box-shadow .18s,border .18s,transform .03s; }
    input:focus{ border-color:var(--emerald); box-shadow:0 0 0 4px var(--ring); }

    /* Hero reorganizado: t√≠tulo a la izquierda, acceso a la derecha */
    .hero{ position:relative; color:#0a2a22; }
    .hero-pad{ padding: clamp(26px, 5.6vw, 56px) 20px; }
    .hero-grid{ display:grid; grid-template-columns:1fr; gap:20px }
    @media (min-width:980px){ .hero-grid{ grid-template-columns:1.2fr .8fr } }

    .display{ margin:8px 0 6px; line-height:1.02; font-weight:800; font-family:'Poppins','Rubik Rounded',sans-serif; font-size: clamp(38px, 7vw, 76px); color:#0c3e33; letter-spacing:.1px }
    .lead{ margin:10px 0 0; max-width:820px; font-size: clamp(16px, 2.2vw, 20px); color:#2f5b52; opacity:.98 }

    /* Cards */
    .card{ position:relative; background:var(--glass); border:1px solid var(--stroke); border-radius:var(--radius-xl); box-shadow:var(--shadow); padding:20px; }

    /* Acceso pulcro: dos botones */
    .access-card h2{ margin:0 0 10px; font-size:22px; color:#0e3e34 }
    .access-card .muted{ color:#40675e; font-size:13px; margin:0 0 10px }

    /* Modales */
    .modal{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(2,16,13,.22); z-index:50 }
    .hide{ display:none !important }

    /* Mensajes */
    .banner{ display:none; background:#fff7ed; border:1px solid #ffedd5; color:#7c3a13; padding:10px 12px; border-radius:12px; margin:10px 0; font-weight:700 }
    .banner.show{ display:block }

    .muted{ color:#40675e; font-size:13px }
    .center{ text-align:center }
    .stack-10{ display:grid; gap:10px }
    .stack-12{ display:grid; gap:12px }
    .row{ display:flex; gap:10px; flex-wrap:wrap }
  </style>
</head>
<body>

  <!-- ===== Header del sitio (logo + nombre) ===== -->
  <header class="site">
    <div class="site-inner">
      <a class="brand" href="#" aria-label="Inicio">
        <span class="logo" aria-hidden="true"></span>
        <span class="brand-name">Prouti</span>
      </a>
      <div class="site-actions">
        <span id="cfgStatus" class="pill">Estado: <span id="cfgState">OK</span></span>
        <button id="btnOpenConfig" class="btn btn-soft" type="button">Configurar conexi√≥n</button>
      </div>
    </div>
  </header>

  <!-- HERO: izquierda t√≠tulo, derecha acceso -->
  <section id="hero-guest" class="hero" aria-labelledby="heroGuestTitle">
    <div class="wrap hero-pad">
      <div class="hero-grid">
        <!-- Columna izquierda: t√≠tulo -->
        <div>
          <h1 id="heroGuestTitle" class="display">Nutrici√≥n simple, progreso real</h1>
          <p class="lead">Calcula tus macros, registra lo que comes y mide tu avance.</p>
        </div>

        <!-- Columna derecha: acceso -->
        <aside class="card access-card" aria-labelledby="accessTitle">
          <h2 id="accessTitle">Acceso</h2>
          <p class="muted">Elige una opci√≥n para continuar.</p>
          <div id="authBanner" class="banner">Conexi√≥n inv√°lida con la base de datos. Revisa la configuraci√≥n.</div>
          <div class="stack-10">
            <button id="btnOpenSignup" class="btn btn-primary" type="button">Reg√≠strate aqu√≠</button>
            <button id="btnOpenLogin" class="btn btn-soft" type="button">Iniciar sesi√≥n</button>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <!-- DASHBOARD (se muestra despu√©s de iniciar sesi√≥n) -->
  <main class="wrap" id="main">
    <section id="dashboard" class="hide" aria-label="Panel de usuario" style="margin-top:6px">
      <h2>Bienvenido üëã</h2>
      <nav class="tabs" aria-label="Secciones del panel">
        <button type="button" onclick="showSection('resumen')">üè† Resumen</button>
        <button type="button" onclick="showSection('comidas')">üçΩÔ∏è Comidas</button>
        <button type="button" onclick="showSection('progreso')">üìä Progreso</button>
      </nav>
      <div id="resumen"><p class="muted">Aqu√≠ ver√°s tu progreso y tus metas del d√≠a.</p></div>
      <div id="comidas" class="hide"><p class="muted">Pr√≥ximamente: registro y b√∫squeda de alimentos.</p></div>
      <div id="progreso" class="hide"><p class="muted">Pr√≥ximamente: gr√°ficos y tendencias.</p></div>
      <div class="center" style="margin-top:14px">
        <button class="btn" type="button" onclick="logout()">Cerrar sesi√≥n</button>
      </div>
    </section>
  </main>

  <!-- MODALES: Config / Signup / Login / Perfil -->
  <div id="configModal" class="modal hide" role="dialog" aria-modal="true" aria-labelledby="cfgTitle">
    <div class="card" style="max-width:560px;width:100%">
      <h2 id="cfgTitle">Configurar conexi√≥n</h2>
      <p class="muted">Pega aqu√≠ el <b>URL</b> y la <b>Anon Key</b> de tu proyecto Supabase. Quedan guardadas localmente.</p>
      <div class="stack-12" style="margin-top:8px">
        <div>
          <label for="cfgUrl">SUPABASE_URL</label>
          <input id="cfgUrl" type="url" placeholder="https://dnygudxhimjksxedzckl.supabase.co" />
        </div>
        <div>
          <label for="cfgKey">SUPABASE_ANON_KEY</label>
          <input id="cfgKey" type="text" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRueWd1ZHhoaW1qa3N4ZWR6Y2tsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njc3MDk1MSwiZXhwIjoyMDcyMzQ2OTUxfQ.VC46pebXQqwwj7wSsH9WCeiEoFuGMXYcv3yTIgsYcxU" />
        </div>
      </div>
      <div id="cfgMsg" class="muted" style="margin-top:8px"></div>
      <div class="row" style="margin-top:12px;justify-content:space-between">
        <button id="btnCfgClear" class="btn btn-danger" type="button">Borrar config</button>
        <div>
          <button id="btnCfgClose" class="btn" type="button">Cancelar</button>
          <button id="btnCfgSave" class="btn btn-primary" type="button">Guardar y probar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="signupModal" class="modal hide" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
    <div class="card" style="max-width:460px;width:100%">
      <h2 id="signupTitle">Crear cuenta</h2>
      <div class="stack-12" style="margin-top:8px">
        <div>
          <label for="suEmail">Correo</label>
          <input id="suEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email" />
        </div>
        <div>
          <label for="suPass">Contrase√±a</label>
          <input id="suPass" type="password" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password" />
        </div>
      </div>
      <p id="suMsg" class="muted" style="margin-top:8px" role="status" aria-live="polite"></p>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button id="btnCloseSignup" class="btn" type="button">Cancelar</button>
        <button id="btnDoSignup" class="btn btn-primary" type="button">Crear cuenta</button>
      </div>
    </div>
  </div>

  <div id="loginModal" class="modal hide" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="card" style="max-width:460px;width:100%">
      <h2 id="loginTitle">Iniciar sesi√≥n</h2>
      <div class="stack-12" style="margin-top:8px">
        <div>
          <label for="liEmail">Correo</label>
          <input id="liEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email" />
        </div>
        <div>
          <label for="liPass">Contrase√±a</label>
          <input id="liPass" type="password" placeholder="Tu contrase√±a" autocomplete="current-password" />
        </div>
      </div>
      <p id="liMsg" class="muted" style="margin-top:8px" role="status" aria-live="polite"></p>
      <div class="row" style="margin-top:12px;justify-content:space-between">
        <button id="btnForgot" class="btn btn-soft" type="button">Olvid√© mi contrase√±a</button>
        <div>
          <button id="btnCloseLogin" class="btn" type="button">Cancelar</button>
          <button id="btnDoLogin" class="btn btn-primary" type="button">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="profileModal" class="modal hide" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
    <div class="card" style="max-width:460px;width:100%">
      <h2 id="profileTitle">Tu perfil</h2>
      <p class="muted" style="margin-top:4px">Tu correo y nombre visible dentro de la app.</p>
      <div class="stack-12" style="margin-top:10px">
        <div>
          <label for="profEmail">Correo</label>
          <input id="profEmail" type="email" disabled />
        </div>
        <div>
          <label for="profName">Nombre visible</label>
          <input id="profName" type="text" placeholder="Tu nombre" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button id="btnCloseProfile" class="btn" type="button">Cerrar</button>
        <button id="btnSaveProfile" class="btn btn-primary" type="button">Guardar</button>
      </div>
      <p id="profMsg" class="muted" style="margin-top:8px" role="status" aria-live="polite"></p>
    </div>
  </div>

  <footer class="wrap" aria-label="Informaci√≥n legal">
    <p class="muted">¬© <span id="year"></span> Prouti. Todos los derechos reservados.</p>
  </footer>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;

    // ===== Config runtime (para resolver ‚ÄúInvalid API key‚Äù sin exponer claves):
    const STORAGE_KEYS = { url: 'prouti.sb.url', key: 'prouti.sb.key' };
    function getCfg(){ return { url: localStorage.getItem(STORAGE_KEYS.url)||'', key: localStorage.getItem(STORAGE_KEYS.key)||'' } }
    function setCfg(url, key){ localStorage.setItem(STORAGE_KEYS.url, url); localStorage.setItem(STORAGE_KEYS.key, key) }
    function clearCfg(){ localStorage.removeItem(STORAGE_KEYS.url); localStorage.removeItem(STORAGE_KEYS.key) }
    function looksLikeJwt(k){ return typeof k==='string' && k.split('.').length===3 }
    function looksLikeUrl(u){ return /^https:\\/\\/[\\w-]+\\.supabase\\.co$/.test(u) }

    let sb = null; // cliente supabase

    function initSupabase(){
      const cfg = getCfg();
      const ok = looksLikeUrl(cfg.url) && looksLikeJwt(cfg.key);
      document.getElementById('cfgState').textContent = ok ? 'OK' : 'Config requerida';
      document.getElementById('authBanner').classList.toggle('show', !ok);
      [ 'btnOpenSignup','btnOpenLogin','btnDoSignup','btnDoLogin','btnForgot' ].forEach(id=>{
        const el = document.getElementById(id); if(el) el.disabled = !ok;
      });
      if(ok){ sb = createClient(cfg.url, cfg.key); }
      return ok;
    }

    // ===== Utilidades UI
    const $ = (id)=>document.getElementById(id);
    const show = (id)=>$(id).classList.remove('hide');
    const hide = (id)=>$(id).classList.add('hide');
    function openModal(id){ show(id); document.body.style.overflow='hidden' }
    function closeModal(id){ hide(id); document.body.style.overflow='' }
    function showSection(sec){ ['resumen','comidas','progreso'].forEach(id=>$(id).classList.toggle('hide', id!==sec)) }

    // ===== Estado de sesi√≥n
    async function getUser(){ if(!sb) return null; const { data:{ user } } = await sb.auth.getUser(); return user||null }
    async function getProfile(userId){ if(!sb) return null; const { data } = await sb.from('profiles').select('*').eq('id', userId).maybeSingle(); return data||null }
    async function ensureProfile(){ const user = await getUser(); if(!user) return null; let prof = await getProfile(user.id); if(!prof){ await sb.from('profiles').insert({ id:user.id, display_name:user.email }); prof = await getProfile(user.id); openModal('profileModal'); } return prof }
    function setLoggedUI(){ hide('hero-guest'); show('dashboard'); }
    function setGuestUI(){ show('hero-guest'); hide('dashboard'); }

    // ===== Header acciones
    document.getElementById('btnOpenConfig').onclick = ()=>{
      const {url,key}=getCfg();
      document.getElementById('cfgUrl').value=url;
      document.getElementById('cfgKey').value=key;
      document.getElementById('cfgMsg').textContent='';
      openModal('configModal');
    };
    document.getElementById('btnCfgClose').onclick = ()=> closeModal('configModal');
    document.getElementById('btnCfgClear').onclick = ()=>{ clearCfg(); document.getElementById('cfgMsg').textContent='Configuraci√≥n borrada.'; initSupabase(); };
    document.getElementById('btnCfgSave').onclick = async ()=>{
      const url = (document.getElementById('cfgUrl').value||'').trim();
      const key = (document.getElementById('cfgKey').value||'').trim();
      if(!looksLikeUrl(url)){ document.getElementById('cfgMsg').textContent='URL no v√°lida (debe ser https://xxxxx.supabase.co)'; return }
      if(!looksLikeJwt(key)){ document.getElementById('cfgMsg').textContent='Anon Key parece inv√°lida (formato JWT)'; return }
      setCfg(url,key);
      const ok = initSupabase();
      if(!ok){ document.getElementById('cfgMsg').textContent='No se pudo inicializar.'; return }
      try{
        await sb.auth.getSession(); // ping
        document.getElementById('cfgMsg').textContent='Conexi√≥n OK ‚úÖ';
        setTimeout(()=> closeModal('configModal'), 600);
      }catch(e){
        document.getElementById('cfgMsg').textContent='No pudimos validar: '+(e?.message||e);
      }
    };

    // ===== Signup
    document.getElementById('btnOpenSignup').onclick = ()=> openModal('signupModal');
    document.getElementById('btnCloseSignup').onclick = ()=> closeModal('signupModal');
    document.getElementById('btnDoSignup').onclick = async ()=>{
      if(!sb){ document.getElementById('suMsg').textContent='Configura la conexi√≥n primero.'; return }
      const email = (document.getElementById('suEmail').value||'').trim();
      const password = (document.getElementById('suPass').value||'').trim();
      const msg = document.getElementById('suMsg'); msg.textContent='';
      if(!/.+@.+\\..+/.test(email)){ msg.textContent='Ingresa un correo v√°lido.'; return }
      if(password.length < 6){ msg.textContent='La contrase√±a debe tener al menos 6 caracteres.'; return }
      try{
        const { data, error } = await sb.auth.signUp({ email, password });
        if(error) throw error;
        if(data?.user && !data.session){ msg.textContent='Cuenta creada. Revisa tu correo para confirmar.'; }
        else{ msg.textContent='Cuenta creada y sesi√≥n iniciada ‚úÖ'; closeModal('signupModal'); await afterLoginShowApp(); }
      }catch(e){ msg.textContent = 'Error: '+(e?.message||e) }
    };

    // ===== Login
    document.getElementById('btnOpenLogin').onclick = ()=> openModal('loginModal');
    document.getElementById('btnCloseLogin').onclick = ()=> closeModal('loginModal');
    document.getElementById('btnDoLogin').onclick = async ()=>{
      if(!sb){ document.getElementById('liMsg').textContent='Configura la conexi√≥n primero.'; return }
      const email = (document.getElementById('liEmail').value||'').trim();
      const password = (document.getElementById('liPass').value||'').trim();
      const msg = document.getElementById('liMsg'); msg.textContent='';
      if(!/.+@.+\\..+/.test(email)){ msg.textContent='Ingresa un correo v√°lido.'; return }
      if(!password){ msg.textContent='Ingresa tu contrase√±a.'; return }
      try{
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error) throw error;
        msg.textContent='Sesi√≥n iniciada ‚úÖ';
        closeModal('loginModal');
        await afterLoginShowApp();
      }catch(e){
        if(String(e?.message||'').toLowerCase().includes('invalid api key')){
          document.getElementById('authBanner').classList.add('show');
          document.getElementById('cfgState').textContent='Config requerida';
          msg.textContent='Clave/API inv√°lida. Abre "Configurar conexi√≥n" y pega tus credenciales.';
        }else{
          msg.textContent = 'No pudimos iniciar sesi√≥n: '+(e?.message||e);
        }
      }
    };

    // Forgot password
    document.getElementById('btnForgot').onclick = async ()=>{
      if(!sb){ document.getElementById('liMsg').textContent='Configura la conexi√≥n primero.'; return }
      const email = (document.getElementById('liEmail').value||'').trim();
      const msg = document.getElementById('liMsg'); msg.textContent='';
      if(!/.+@.+\\..+/.test(email)){ msg.textContent='Escribe el correo que usaste para registrarte.'; return }
      const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
      msg.textContent = error ? ('No se pudo enviar: '+error.message) : 'Te enviamos un enlace para restablecer tu contrase√±a ‚úÖ';
    };

    async function logout(){ if(sb) await sb.auth.signOut(); setGuestUI(); }

    async function afterLoginShowApp(){ const user = await getUser(); if(!user){ setGuestUI(); return } const profile = await ensureProfile(); setLoggedUI({ user, profile }) }

    (async ()=>{
      document.getElementById('year').textContent = new Date().getFullYear();
      // Inicializar supabase con posibles credenciales guardadas
      initSupabase();
      // Restaurar sesi√≥n desde hash
      const hash = window.location.hash || '';
      if(hash.includes('access_token') && hash.includes('refresh_token') && sb){
        const p = new URLSearchParams(hash.substring(1));
        await sb.auth.setSession({ access_token: p.get('access_token'), refresh_token: p.get('refresh_token') });
        history.replaceState({}, document.title, window.location.pathname);
      }
      const user = await getUser();
      if(user) await afterLoginShowApp(); else setGuestUI();
    })();
  </script>
</body>
</html>
